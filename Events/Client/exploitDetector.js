const { EmbedBuilder } = require('discord.js');
const path = require('path');
const fs = require('fs');

async function handleFlaggedWord(client, message) {
  const flaggedWords = ['flagged', 'word1', 'word2']; // List of flagged words

  const channelId = '1102802056529575946'; // The ID of the Discord channel
  const flaggedFolderPath = '../../Anti Cheat'; // The folder path to save the flagged files

  const content = message.content; // Get the original message content

  if (content) {
    for (const flaggedWord of flaggedWords) {
      if (content.includes(flaggedWord)) {
        console.log(`Flagged word detected: ${flaggedWord}`);

        // Send flagged report to the Discord channel
        const channel = await client.channels.fetch(channelId);
        if (channel.isText()) {
          await channel.send(`User ${message.author} has used the flagged word: ${flaggedWord}`);
        }

        // Generate and save file in the flagged folder
        const attachment = message.attachments.first();
        if (attachment) {
          console.log('Attachment found!');
          const fileExtension = attachment.name.split('.').pop();
          const fileName = `${message.id}.${fileExtension}`;
          const filePath = `${flaggedFolderPath}/${fileName}`;
          await attachment.save(filePath);
          console.log(`Flagged file saved at ${filePath}`);
        } else {
          console.log('No attachment found!');
        }

        // Reply with an embed
        const embed = new EmbedBuilder()
          .setColor('#FF0000')
          .setTitle('Flagged Word Detected')
          .setDescription(`Your message contained the flagged word: ${flaggedWord}`)
          .addFields(
            { name: 'Report Sent', value: 'A report has been sent to the developers.' },
            { name: 'File Saved', value: 'The file has been saved for further review.' }
          );

        message.reply({ embeds: [embed] });

        break; // Exit the loop after the first flagged word is found
      }
    }
  }
}

module.exports = {
  name: 'messageCreate',
  execute: handleFlaggedWord,
};